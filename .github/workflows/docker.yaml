name: 'Terraform'

on:
  push:
    branches: 
    - master

jobs:
  Build:
    name: "Docker build"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: "Build"
      run: |
        docker login --username cloudson --password ${{ secrets.DOCKERHUB_TOKEN }}
        cd 3-continuous-deployment/flux/services/producer
        make
        cd - 
        cd 4-telemetry/flux/services/api
        make 
  Helm:
    name: "Helm release"
    runs-on: ubuntu-latest
    needs: Build
    steps:
    - uses: actions/checkout@v2
    - name: "Helm"
      run: |
        cd 3-continuous-deployment/helm/producer
        sed 's/latest/${{ secrets.GITHUB_SHA }}/g' values.yaml > values.yaml
    - uses: helm/chart-releaser-action@v1.1.0
      with:
        charts_dir: 3-continuous-deployment/helm/producer
      env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"    
